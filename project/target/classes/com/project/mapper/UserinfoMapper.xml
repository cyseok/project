<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.mapper.UserinfoMapper">

   <!--회원가입 -->
   
   <!-- 회원정보 삽입 -->
   <insert id="insertUserinfo">
      INSERT INTO 
      userinfo (
         id
         , pw
         , name
         , email
         , regdate
         , status  
         , enabled
      )
      VALUES (
         #{id}
         , #{pw}
         , #{name}
         , #{email}
         , Now()
         , #{status}
         , 0
      )
   </insert>
   
   <!-- Auth -->
   <insert id="insertSecurityAuth">
      INSERT INTO security_auth 
      VALUES (
            #{id}
          , #{auth}
            )
   </insert>
   
   <resultMap type="Userinfo" id="securityUserinfoResultMap">
      <id column="id" property="id"/>
      <result column="pw" property="pw"/>
      <result column="name" property="name"/>
      <result column="regdate" property="regdate"/>
      <result column="status" property="status"/>
      <result column="enabled" property="enabled"/>
      <collection property="securityAuthList" select="selectSecurityAuthById" column="id"/>
   </resultMap> 
   
   <select id="selectSecurityAuthById" resultType="SecurityAuth">
      SELECT id
         , auth 
      FROM security_auth 
      WHERE id=#{id}
   </select>
   
  
    <select id="selectUserinfoById" resultMap="securityUserinfoResultMap">
		SELECT userinfo.id
        	 , userinfo.pw
         	 , userinfo.name
          	 , userinfo.email
           	 , userinfo.regdate
         	 , userinfo.status  
         	 , userinfo.enabled
         	 , security_auth.auth
    	FROM userinfo
    	LEFT JOIN security_auth
    	ON userinfo.id=security_auth.id
    	WHERE userinfo.id=#{id}
	</select>


     <!-- 아이디 중복검사 -->
     <select id="idCheck" resultType="int">
        SELECT count(*) FROM userinfo 
        WHERE id = #{id}
     </select>
     
          <!-- 이메일 중복검사 -->
     <select id="emailCheck" resultType="int">
        SELECT count(*) FROM userinfo 
        WHERE email = #{email}
     </select>
  
 
   
   
  	 <!-- 로그인 시간 변경 -->
  	 <update id="updateLogdate"> 
        UPDATE userinfo
        SET logdate= Now()
        WHERE id= #{id}
     </update>
   
     <!-- 비밀번호 인코딩 후 -->
     <select id="userinfoLogin" resultType="Userinfo">
        SELECT *
        FROM userinfo
        WHERE id=#{id}
     </select>

     <!-- 이메일로 사용자 ID 찾기 -->
      <select id="findUserByEmail" parameterType="string" resultType="com.project.dto.Userinfo">
          SELECT * 
          FROM userinfo 
          WHERE email = #{email}
      </select>   



    
   <!-- 관리자 -->
   
      <select id="selectUserinfoCount">
      SELECT COUNT(*) FROM Userinfo
   </select>
   
    <!-- 전체 유저 정보 검색 -->
   <select id="selectUserinfoOrderById" resultType="Userinfo">
      SELECT 
         id
         , pw
         , name
         , email
         , regdate
         , logdate
         , status
         , enabled 
      FROM userinfo 
      ORDER BY id
   </select>
   
	<select id="selectUserinfoList" resultType="Userinfo">
	  SELECT 
	    id,
	    pw,
	    name,
	    email,
	    regdate,
	    logdate,
	    status,
	    enabled
	  FROM userinfo
	  ORDER BY id DESC
	  LIMIT #{startRow}, #{endRow}
	</select>
   
   
   <!-- 조건에 따른 유저 정보 검색 -->
   <sql id="search">
      <if test="condition != null and keyword != null">
            <if test="condition == 'name'">
               <!-- 검색조건이 name이라면 -->
               AND name LIKE '%'||#{keyword}||'%'
            </if>
            <if test="condition == 'id'">
               <!-- 검색조건이 id라면 -->
               AND id LIKE '%'||#{keyword}||'%'
            </if>
            <if test="condition == 'email'">
               <!-- 검색조건이 email라면 -->
               AND email LIKE '%'||#{keyword}||'%'
            </if>
            <if test="condition == 'regdate'">
               <!-- 검색조건이 regdate라면 -->
               AND regdate LIKE '%'||#{keyword}||'%' 
            </if>
            <if test="condition == 'status'">
               <!-- 검색조건이 status라면 -->
               AND status LIKE '%'||#{keyword}||'%' 
            </if>
         </if>
      </sql>
      
      

   
   
</mapper>